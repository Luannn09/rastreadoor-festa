<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Rastreador de Amigos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    #formulario, #botoes, #buscador {
      position: absolute;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    #formulario {
      top: 10px;
      left: 10px;
    }
    #botoes {
      display: none;
      top: 10px;
      left: 10px;
      flex-direction: column;
      gap: 8px;
    }
    #buscador {
      top: 10px;
      right: 10px;
      display: none;
    }
    input, button, select {
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      font-size: 16px;
    }
    #seta {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) rotate(0deg);
      font-size: 40px;
      display: none;
      z-index: 1002;
    }
  </style>
</head>
<body>
  <div id="formulario">
    <input type="text" id="nome" placeholder="Seu nome">
    <button onclick="iniciar()">Entrar</button>
  </div>

  <div id="botoes">
    <button onclick="centralizarMapa()">Centralizar Amigos</button>
    <button onclick="abrirSelecaoAmigo()">Encontrar Amigo</button>
    <button onclick="sair()">Sair</button>
  </div>

  <div id="buscador">
    <select id="listaAmigos"></select>
    <button onclick="confirmarAmigo()">Localizar</button>
  </div>

  <div id="map"></div>
  <div id="seta">ðŸ§­</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAO0izXY6DJm_e6dcyAOwlnuImg31okxBE",
      authDomain: "festa-rastreio-20.firebaseapp.com",
      databaseURL: "https://festa-rastreio-20-default-rtdb.firebaseio.com",
      projectId: "festa-rastreio-20",
      storageBucket: "festa-rastreio-20.appspot.com",
      messagingSenderId: "811662076993",
      appId: "1:811662076993:android:eafe8cccce3242e9852ac0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let mapa, usuario = "", marcadores = {}, posicaoAtual = null;
    let amigoAlvo = null;
    const cores = ["red", "blue", "green", "orange", "purple", "brown", "pink"];

    function iniciar() {
      const nomeInput = document.getElementById("nome").value.trim();
      if (!nomeInput) return alert("Digite seu nome!");
      usuario = nomeInput;

      document.getElementById("formulario").style.display = "none";
      document.getElementById("botoes").style.display = "flex";

      mapa = L.map('map').setView([-15.7939, -47.8828], 17);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Mapa por OpenStreetMap',
      }).addTo(mapa);

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            posicaoAtual = { lat, lng };
            db.ref("usuarios/" + usuario).set({
              nome: usuario,
              lat,
              lng,
              timestamp: Date.now()
            });
          },
          err => alert("Erro ao obter localizaÃ§Ã£o: " + err.message),
          { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
        );
      } else {
        alert("Seu navegador nÃ£o suporta localizaÃ§Ã£o.");
      }

      db.ref("usuarios").on("value", snapshot => {
        const dados = snapshot.val() || {};
        const agora = Date.now();
        const bounds = [];

        for (let id in dados) {
          const u = dados[id];

          if (agora - (u.timestamp || 0) > 120000) {
            db.ref("usuarios/" + id).remove();
            if (marcadores[id]) {
              mapa.removeLayer(marcadores[id]);
              delete marcadores[id];
            }
            continue;
          }

          const cor = cores[id.length % cores.length];
          const icon = L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color:${cor}; width:20px; height:20px; border-radius:50%"></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });

          if (!marcadores[id]) {
            marcadores[id] = L.marker([u.lat, u.lng], { icon }).addTo(mapa).bindPopup(u.nome);
          } else {
            marcadores[id].setLatLng([u.lat, u.lng]);
          }

          bounds.push([u.lat, u.lng]);
        }
      });
    }

    function centralizarMapa() {
      const todos = Object.values(marcadores).map(m => m.getLatLng());
      if (todos.length) {
        const group = new L.featureGroup(Object.values(marcadores));
        mapa.fitBounds(group.getBounds().pad(0.2));
      }
    }

    function sair() {
      if (usuario) {
        db.ref("usuarios/" + usuario).remove();
        location.reload();
      }
    }

    function abrirSelecaoAmigo() {
      const select = document.getElementById("listaAmigos");
      select.innerHTML = "";

      Object.keys(marcadores).forEach(nome => {
        if (nome !== usuario) {
          const opt = document.createElement("option");
          opt.value = nome;
          opt.innerText = nome;
          select.appendChild(opt);
        }
      });

      if (select.length === 0) {
        alert("Nenhum amigo disponÃ­vel agora.");
        return;
      }

      document.getElementById("buscador").style.display = "block";
    }

    function confirmarAmigo() {
      const escolhido = document.getElementById("listaAmigos").value;
      amigoAlvo = escolhido;
      document.getElementById("buscador").style.display = "none";
      document.getElementById("seta").style.display = "block";
    }

    window.addEventListener("deviceorientationabsolute", atualizarSeta, true);
    window.addEventListener("deviceorientation", atualizarSeta, true);

    function atualizarSeta(e) {
      if (!amigoAlvo || !marcadores[amigoAlvo] || !posicaoAtual) return;

      const amigoLatLng = marcadores[amigoAlvo].getLatLng();
      const minhaLatLng = posicaoAtual;

      const angleToFriend = getAngle(minhaLatLng.lat, minhaLatLng.lng, amigoLatLng.lat, amigoLatLng.lng);
      const deviceDirection = e.alpha || 0;

      const ajuste = angleToFriend - deviceDirection;
      document.getElementById("seta").style.transform = `translateX(-50%) rotate(${ajuste}deg)`;
    }

    function getAngle(lat1, lon1, lat2, lon2) {
      const dLon = (lon2 - lon1);
      const y = Math.sin(dLon * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180);
      const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon * Math.PI / 180);
      const brng = Math.atan2(y, x) * 180 / Math.PI;
      return (brng + 360) % 360;
    }
  </script>
</body>
</html>
